# day13

haproxy博客：https://cloud.tencent.com/developer/article/1644907

## 负载均衡

### nginx负载均衡



## LVS

#### 介绍

* 群集又称为集群、Cluster，是由多台主机构成，但是对外依然是一个整体，只提供一个访问入口（域名或IP地址），相当于一台大型计算机。
* LB集群原理：当用户请求发送过来时，直接分发到Director server上，然后在根据设置好的智能算法，智能均衡的分发到后端的真正服务器（real server)上，为了保证用户请求数据一致，需要共享存储。（LB:负载均衡）
* LVS架构可以从逻辑上分为调度层、server层、共享存储。
* 官网：www.linuxvirtualserver.org

#### 组成

* ipvs ：工作在内核区，真正实现调度的代码。
* ipvsadm：工作在用户空间，负责为ipvs编写规则，定义集群和后端真实服务器。
* 相关术语
  * RS：后端真实服务器工作服务器
  * DS：前端负载均衡节点
  * VIP：用户请求的IP地址
  * DIP：内部主机通讯的IP地址
  * RIP：后端服务器的IP地址
  * CIP：客户端（用户）的IP地址

#### NAT模式

当用户访问服务器集群提供的服务时，发往虚拟IP地址的请求数据包（负载均衡器的外部IP地址）到达 负载均衡器。负载 均衡器检查数据包的目标地址和端口号。如果根据虚拟服务器规则表匹配虚拟服务器 服务，则通过调度算法从集群中选择 真实服务器，并将连接添加到记录已建立连接的哈希表中。然后， 将目标地址和数据包的端口重写为所选服务器的目标地 址和端口，并将数据包转发到服务器。当传入数 据包属于此连接并且可以在哈希表中找到所选服务器时，将重写该数据包 并将其转发到所选服务器。当 回复数据包返回时，负载均衡器将数据包的源地址和端口重写为虚拟服务的源地址和端口。 连接终止或 超时后，连接记录将在哈希表中删除。

![LVS_NAT原理和特点](https://img-blog.csdnimg.cn/img_convert/b6c226a71f4b69e0b90eadcda986d577.png)

* 特点
  * RS为私有地址，网关为DIP
  * DIP和RIP属于一个网段
  * 请求和响应经过DS，有性能瓶颈
  * RS为任意操作系统

#### DR模式

此请求调度方法类似于IBM的NetDispatcher中实现的方法。虚拟IP地址由真实服务器和负载均衡器共 享。负载均衡器的 接口也配置了虚拟IP地址，用于接受请求数据包，并直接将数据包路由到选定的服务 器。所有真实服务器的非arp别名接 口都配置了虚拟IP地址，或者将发往虚拟IP地址的数据包重定向到本 地套接字，以便真实服务器可以在本地处理数据包。 负载均衡器和真实服务器必须通过HUB/Switch物 理连接其中一个接口，负载均衡器只是将数据帧的MAC地址更改为所选 服务器的MAC地址，然后在LAN 上重新传输。这就是负载均衡器和每个服务器必须通过同一个LAN进行连接的原因。

![image-20220714085434832](C:\Users\xz\AppData\Roaming\Typora\typora-user-images\image-20220714085434832.png)

* 特点
  * Director Server 和 Real Server 必须在同一个物理网络中
  * Real Server 可以使用私有地址，也可以使用公网地址。如果使用公网地址，可以通过互联网对 RIP 进行直接访问。
  * Director Server 作为群集的访问入口，但不作为网关使用。
  * 所有的请求报文经由 Director Server，但回复响应报文不能经过 Director Server。
  * Real Server的网关不允许指向Director Server IP，即 Real Server 发送的数据包不允许经过 Director Server。
  * Real Server 上的 lo 接口配置 VIP 的 IP 地址。

#### TUN模式

在LVS（NAT）模式的集群环境中，由于所有的数据请求及响应的数据包都需要经过LVS调度器转发，如 果后端服务器的 数量大于10台，则调度器就会成为整个集群环境的瓶颈。我们知道，数据请求包往往远 小于响应数据包的大小。因为响 应数据包中包含有客户需要的具体数据，所以LVS（TUN）的思路就是 将请求与响应数据分离，让调度器仅处理数据请 求，而让真实服务器响应数据包直接返回给客户端。 LVS/TUN工作模式拓扑结构如图3所示。其中，IP隧道（IP tunning）是一种数据包封装技术，它可以将 原始数据包封装并添加新的包头（内容包括新的源地址及端口、目标地址及 端口），从而实现将一个目 标为调度器的VIP地址的数据包封装，通过隧道转发给后端的真实服务器（Real Server），通 过将客户 端发往调度器的原始数据包封装，并在其基础上添加新的数据包头（修改目标地址为调度器选择出来的 真实服务 器的IP地址及对应端口），LVS（TUN）模式要求真实服务器可以直接与外部网络连接，真实 服务器在收到请求数据包后 直接给客户端主机响应数据。

![image-20220714203205972](C:\Users\xz\AppData\Roaming\Typora\typora-user-images\image-20220714203205972.png)

特点

* RS网关不能指向DIP
* 请求报文经过DS，响应报文直接有RS发送给客户端
* RIP,VIP,DIP公网地址
* 不支持端口映射，RS支持隧道

`高可用性的目的就是实现业务的连续性，即在用户眼中，业务永远正常对外提供服务。`

#### LVS实验

欧威交付物