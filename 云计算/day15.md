# day15

### 数据通信基础
#### OSI七层网络模型
|---:    | ------: |
名称  | 作用   |
应用层|提供程序间的通信|
表示层| 处理数据格式，数据加密|
会话层|建立，维护和管理会话|
传输层|建立端到端的链接|
网络层|寻址和路由选择|
数据链路层|差错检测，封装成帧，透明传输|
物理层|传输比特流|

* 物理层
通过不管什么介质，将信息的二进制比特流传送到另一个节点
* 数据链路层
将物理层传送过来的二进制信息封装，封装成数据帧
以太网传递的数据都是二进制信号，以太网卡会内置芯片，处理最初的112个二进制。
1. 前48位为目的地的MAC地址（相当于身份证，唯一）
1.1 之后的48位是发送者的MAC地址
1.2 之后的16位是数据报类型
2. 0x0800，ipv4数据报文
2.1 0x08dd，ipv6数据报文
2.2 打开cmd，ipconfig/all,查看MAC地址
3. MAC地址
3.1 前24组织唯一标识符，看出产商
4. 物理层被看成不可靠的
4.1数据链路层通过CRC循环冗余校验生成校验码，放在最后的FCS，保证数据正确。
* 网络层
1. 路由，寻址功能
2. 当计算机得知ipv4时，后续用ipv4理解
3. 协议
3.1 tcp：6
3.2 UDP：17
4. 源与目的地址
4.1 mac地址比作为身份证号，那么ip地址就是当前你所处的位置，快递小哥通过你的位置找到你，通过你的身份证确认你
* 传输层
1.  判断数据的业务
2.  源的端口号
2.1 范围：1-65535
2.2 默认关闭
2.3 windows中默认端口号
|:---|:---|
协议名|端口号
|http|80/tcp
|ftp|20/tcp,21/tcp
mstsc|3389/tcp,3389udp
dns|54/tcp,53/udp
telnet|23/tcp
ssh|22/tcp
* 应用层
产生用户数据，用户数据交互接口
### IP地址
- IP地址为32位
- IP地址网络位
   - 网络位相同说明处于同一个局域网
- IP地址主机位
   - 网络位相同，主机位不能相同
   - 目的是帮助局域网设备进行高层的通信封装
- 网络类型
   - A类：1.0.0.0 ~255.255.255.255/8
       - 127开头作为本地测试地址
       - A类地址的局域网只能有2^24-2个设备
   - B类：128.0.0.0~191.255.255.255/16
       - B类地址最多2^16-2个
   - C类：192.0.0.0~223.255.255.255.255/24
       - C类地址最多2^8-2 
   - D类没有网络位
     - D类地址
      用于多点广播（Multicast）。 D类IP地址第一个字节以“lll0”开始，它是一个专门保留的地址。它并不指向特定的网络，目前这一类地址被用在多点广播（Multicast）中。多点广播地址用来一次寻址一组计算机，它标识共享同一协议的一组计算机。224.0.0.0到239.255.255.255用于多点广播 。

   - E用不到
      - 以“llll0”开始，为将来使用保留。240.0.0.0到255.255.255.254，255.255.255.255用于广播地址。
       全零（“0．0．0．0”）地址对应于当前主机。全“1”的IP地址（“255．255．255．255”）是当前子网的
        广播地址。
   - 使用子网掩码区分网络位与主机位
### 私有IP地址
:-----|
私有IP地址空间|地址范围|
10.0.0.0/8|10.0.0.0~10.255.255.255
172.16.0.0/12|172.16.0.0~172.31.255.255
192.168.0.0/16|192.168.0.0~192.168.255.255

### 子网掩码
子网掩码与IP地址搭配使用，用于表示网络位与主机位的部分
子网掩码有32位，与IP地址相对应
<img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.pianshen.com%2Fimages%2F225%2Fc9e2458715ddebdd1b4741ab72e6a2f1.png&amp;refer=http%3A%2F%2Fwww.pianshen.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1660474405&amp;t=94b824e1ec9e6a8d0fe72bcad80e1488"/>
- 减少局域网数量可以降低能耗
- 可以分配的主机地址更小
#### TCP/UDP
***
### 三次握手四次挥手
1）第一次握手：客户端向服务端发送一个 SYN报文（SYN = 1），并指明客户端的初始化序列号ISN(x)，即图中的seq = x，表示本报文段所发送的数据的第一个字节序号。此时客户端处于 SYN_Send 状态。
2）第二次握手：服务器收到客户端的 SYN 报文之后，会发送 SYN报文作为应答（SYN = 1），并且指定自己的初始化序列号ISN(y)，即图中的 seq = y。同时会把客户端的 ISN + 1作为确认号 ack 的值，表示已经收到了客户端发来的的 SYN报文，希望收到的下一个数据的第一个字节的序号是 x +1，此时服务器处于 SYN_REVD 的状态。
3）第三次握手：客户端收到服务器端响应的 SYN 报文之后，会发送一个 ACK 报文，也是一样把服务器的 ISN + 1 作为 ack 的值，表示已经收到了服务端发来的的 SYN 报文，希望收到的下一个数据的第一个字节的序号是 y + 1，并指明此时客户端的序列号 seq = x + 1（初始为 seq = x，所以第二个报文段要 +1），此时客户端处于 Establised 状态。服务器收到 ACK 报文之后，也处于 Establised 状态，至此，双方建立起了 TCP 连接。
1）第一次挥手：客户端发送一个 FIN 报文（请求连接终止：FIN = 1），报文中会指定一个序列号 seq = u。并停止再发送数据，主动关闭 TCP 连接。此时客户端处于 FIN_WAIT1 状态，等待服务端的确认。
2）第二次挥手：服务端收到 FIN 之后，会发送 ACK 报文，且把客户端的序号值 +1 作为 ACK 报文的序列号值，表明已经收到客户端的报文了，此时服务端处于 CLOSE_WAIT状态。
3）第三次挥手：如果服务端也想断开连接了（没有要向客户端发出的数据），和客户端的第一次挥手一样，发送 FIN 报文，且指定一个序列号。此时服务端处于 LAST_ACK 的状态，等待客户端的确认。
4）第四次挥手：客户端收到 FIN 之后，一样发送一个 ACK 报文作为应答（ack = w+1），且把服务端的序列值 +1 作为自己 ACK 报文的序号值（seq=u+1），此时客户端处于 TIME_WAIT（时间等待）状态。
* 博客：https://baijiahao.baidu.com/s?id=1693383134922615393&wfr=spider&for=pc
***
### 数据封装
<img src="https://bkimg.cdn.bcebos.com/pic/a044ad345982b2b7aad2fe7232adcbef76099b33?x-bce-process=image/watermark,image_d2F0ZXIvYmFpa2UxMTY=,g_7,xp_5,yp_5/format,f_auto"/>

![8672877cbbf37442ded9dd31c7fac36b.png](../_resources/73405f56b7df40d49159c96549499e7e.png)
- IP地址是用来标识网络中位置的，比如你在江苏省xxx市xxx路xxx号
- MAC地址是每个网络设备的唯一ID，比如你的身份证号码
- 如果想要发送数据，必须(暂且认为必须)同时拥有IP和MAC地址
- Linux的网络管理基础部分就是需要大家掌握IP地址的配置
***
* 物理层：
解决两个硬件之间怎么通信的问题，常见的物理媒介有光纤、电缆、中继器等。它主要定义物理设备标准，如网线的接口类型、光纤的接口类型、各种传输介质的传输速率等。

它的主要作用是传输比特流（就是由1、0转化为电流强弱来进行传输，到达目的地后在转化为1、0，也就是我们常说的数模转换与模数转换）。这一层的数据叫做比特。

* 数据链路层：
在计算机网络中由于各种干扰的存在，物理链路是不可靠的。该层的主要功能就是：通过各种控制协议，将有差错的物理信道变为无差错的、能可靠传输数据帧的数据链路。

它的具体工作是接收来自物理层的位流形式的数据，并封装成帧，传送到上一层；同样，也将来自上层的数据帧，拆装为位流形式的数据转发到物理层。这一层的数据叫做帧。

* 网络层：
计算机网络中如果有多台计算机，怎么找到要发的那台？如果中间有多个节点，怎么选择路径？这就是路由要做的事。

该层的主要任务就是：通过路由选择算法，为报文（该层的数据单位，由上一层数据打包而来）通过通信子网选择最适当的路径。这一层定义的是IP地址，通过IP地址寻址，所以产生了IP协议。

* 传输层：
当发送大量数据时，很可能会出现丢包的情况，另一台电脑要告诉是否完整接收到全部的包。如果缺了，就告诉丢了哪些包，然后再发一次，直至全部接收为止。

简单来说，传输层的主要功能就是：监控数据传输服务的质量，保证报文的正确传输。

* 会话层：
虽然已经可以实现给正确的计算机，发送正确的封装过后的信息了。但我们总不可能每次都要调用传输层协议去打包，然后再调用IP协议去找路由，所以我们要建立一个自动收发包，自动寻址的功能。于是会话层出现了：它的作用就是建立和管理应用程序之间的通信。

* 表示层：
表示层负责数据格式的转换，将应用处理的信息转换为适合网络传输的格式，或者将来自下一层的数据转换为上层能处理的格式。

* 应用层：
应用层是计算机用户，以及各种应用程序和网络之间的接口，其功能是直接向用户提供服务，完成用户希望在网络上完成的各种工作。前端同学对应用层肯定是最熟悉的。
<img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cub3BlbndydGRsLmNvbS93b3JkcHJlc3Mvd3AtY29udGVudC91cGxvYWRzLzIwMTkvMDUvMTA5OTY2OC0yMDE3MDIxMjE1MzMzODEzNS0xMjU0OTI0MjQuZ2lm"/>
***
#### IP网络通信类型
- 单播
- 广播
- 组播
***
## 思科命令介绍
- 三种模式
  - 用户模式：只能查看有限的查看和测试
  - 特权模式：进行完整的查看和测试，允许恢复出厂设置和重启设备
  - （xxx）#各种配置模式：
    - R1（config):全局配置模式，可以配置设备属性，只有全局配置才能进入其他自配置模式
    - R1（config-if）：接配置模式，配置接口属性
    - R1（dhcp-config）：DHCP配置，修改DHCP池属性
### 静态路由
- 特点
  - 需要手动配置
  - 组网较小的场景
  - 无法根据拓扑图动态响应
  - 大型网络采用动静结合进行部署
- 配置方式
`R1(config)# ip route network-address subnet-mask`
### 环路接口
- 配置接口
`interface loopback1 `
- 除非手工shuntdown，否则不会down
- loopback接口
```
模拟路由器的直连网段，可用于测试；
可用于设备管理（Loopback接口比较稳定）；
供其他协议使用，例如OSPF、BGP、MPLS等；
SNMPTraps消息的源地址；
其他用途（Loopback接口的用途十分广泛）。
```
### 缺省路由
`ip route 0.0.0.0 0.0.0.0 ip/net`
### DHCP实验
拓扑图


路由器配置
```
================R1 配置dhcp服务端==============
R1#conf t
R1(config)#int e0/0
R1(config-if)#ip add 192.168.1.1 255.255.255.0
R1(config-if)#no sh
R1(config-if)#ip dhcp pool cisco # 创建一个地址池
R1(dhcp-config)#network 192.168.1.0 /24 # 在地址池中放一个网段
R1(dhcp-config)#default-router 192.168.1.1 # 设置默认网关
R1(dhcp-config)#dns-server 114.114.114.114 114.114.115.115 # 设置主备DNS
R1(dhcp-config)#lease 1 # 租约时间改为1天
R1(dhcp-config)#exit
R1(config)#ip dhcp excluded-address 192.168.1.1 # 设置排除地址
================R2 R3 配置dhcp客户端==============
R3#conf t
Enter configuration commands, one per line. End with CNTL/Z.
R3(config)#int e0/0
R3(config-if)#ip add dhcp
R3(config-if)#no sh
R2#conf t
Enter configuration commands, one per line. End with CNTL/Z.
R2(config)#int e0/0
R2(config-if)#ip add dhcp
R2(config-if)#no sh
```
在路由器上查看地址池分配的情况
```
R1#show ip dhcp binding
Bindings from all pools not associated with VRF:
IP address Client-ID/ Lease expiration Type
Hardware address/
User name
192.168.1.2 010c.18a5.e949.00 Jun 17 2020 09:04 AM Automatic
192.168.1.3 010c.18a5.fca9.00 Jun 17 2020 09:05 AM Automatic
```


***
### DNS域名系统
DNS(Domain Name System) 是一套从域名到IP的映射系统。
在网络中要确定一台主机，可以通过IP地址来做到。但是IP地址不方便记忆， 于是人们发明了一种叫主
机名的东西 。
最初时候人们把主机名和IP地址的对应关系都写在一个hosts文件里面，然后这个hosts文件由“互联网信
息中心（SRI-NIC）”来管理和分发。也就是人们需要定期更新hosts文件。这个文件目前在windows系统
的 C:\Windows\System32\drivers\etc\hosts 中。
时间长了，这个Hosts的机制并不好用，而且更新不及时，主机名多了之后hosts文件太大了，后来就不
用这个机制了。
人们后来改用域名解析系统DNS
```
一个组织的系统管理机构，维护系统内的每个主机的 IP和主机名的对应关系
如果新计算机接入网络，将这个信息注册到数据库中
用户输入域名的时候，会自动查询DNS服务器，由DNS服务器检索数据库,得到对应的IP地址。
```
域名
- .：根域名
- com： 一级域名，表示这是一个企业域名。同级的还有"net"(网络提供商)，"org"(非盈利组织)等。
- baidu: 二级域名, 公司名。
- www: 只是一种习惯用法，并不是每个域名都支持。
- http:// : 要使用什么协议来连接这个主机名。

#### 域名解析过程
```
1. 浏览器缓存
2. 系统缓存,查找hosts文件
3. 路由器缓存————————以上三步均为DNS客户端的缓存！！
4. ISP DNS缓存
5. 根域名服务器
6. 顶级域名服务器
7. 主机名服务器
8. 保存结果至缓存
DNS查询类型
本地解析：过以前查询获得的缓存信息就地应答查询
递归查询：DNS服务器代表请求客户机联系其他DNS服务器，以完全解析，返回给客户机
迭代查询：客户机自己不断请求DNS服务来解析名称，典型的DNS服务器之间的交互
```
当你在浏览器输入www.baidu.com之后会发生什么？
1. 浏览器发起域名解析，首先查询浏览器缓存，如果没有，就查询hosts文件，如果没有就提出域名
解析请求
2. 客户机提出域名解析请求，并将该请求发送给本地的域名服务器。
3. 当本地的域名服务器收到请求后,就先查询本地的缓存,如果有该纪录项,则本地的域名服务器就直接
把查询的结果返回。
4. 如果本地的缓存中没有该纪录,则本地域名服务器就直接把请求发给根域名服务器,然后根域名服务
器再返回给本地域名服务器一个所查询域(根的子域)的主域名服务器的地址。
5. 本地服务器再向上一步返回的域名服务器发送请求,然后接受请求的服务器查询自己的缓存,如果没
有该纪录,则返回相关的下级的域名服务器的地址。
6. 重复第四步,直到找到正确的纪录。
7. 本地域名服务器把返回的结果保存到缓存,以备下一次使用,同时还将结果返回给客户机
***
#### 域名解析记录
```
A：记录地址，返回的域名所指向IP地址
NS：域名服务器，返回保存下一级域名信息的服务器地址。该记录只能设置为域名，不能设置为IP地址
MX：邮箱记录，返回接收电子邮箱的服务器地址
CNAME：规范名称记录，返回另一个域名，即当前查询的域名是另一个域名的跳转
PTR：逆查域名，只用于IP地址查询域名
dig -x
dig [a ns mx ] 查询指定的记录类型
扩展：
TXT：用来做SPF（反垃圾邮箱）
AAAA：用来指定主机名（或域名）对应的IPv6记录。
SRV：记录哪台计算机提供哪个服务。格式：服务
名字、点、协议的类型。
显性URL：从一个地址301重定向另一个地址的时候。 隐性URL：类似显性URL、区别在于隐形URL不会
改
变地址中的域名。
```