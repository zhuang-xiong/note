# day18

#### AS

* AS:automatic systemc
* 不同的AS通过不同的AS号区分，AS的范围（1~65525），64512~65535是私有AS号，IANA负责划分
* 中国电信163AS号：4134
* 中国电信CN2AS号：4809
* 中国网通AS号：9929

#### IGP

* 内部网关协议
* 执行拓扑发现
* 尽力完成快速收敛
* 需要周期性的更新来保证路由信息的精确性
* 受同一个管理机构控制
* 采取共同的路由选择策略
* 提欧共优先的策略控制能力

#### EGP

* 外部网关协议
* 被BGP取代

#### BGP

* 边界网关协议（路径矢量）
* 主要作用是AS之间传递路由信息
* 版本：v1，v2，v3，v4
* 使用的原因
  * 大量路由需要承载，IGP只能承载千条，BGP可以承载万条
  * 支持VPN
  * 策略能力强，可以实现路由决策与数据控制
* BGP使用TCP传输层协议，TCP端口号：179
* BGP路由器之间建立TCP连接，这些路由称为BGP对等体，或者邻居：EBGP,IBGP
* 对等体交换整个BGP路由表
* BGP只能增量更新或者触发更新（不会定期更新）
* 丰富的路径属性
* BGP通告上万路由，采用TCP滑窗机制，停止并等待确认前，发送65576个字节

#### 拓扑



***

#### BGP邻居

* 运行BGP的路由器叫BGP speaker
* BGP对等体也叫BGP邻居，建立基于TCP
* IBGP
  * 邻居与自己处于一个AS中
  * 通过IBGP学习到的路由管理距离为200
  * 从IBGP学到的路由不会传递其他的IBGP邻居
  * 如果开启BGP同步，那么没有在IBGP学习到的路由，BGP也不会用
  * IBGP邻居传递路由默认不会修改下一跳地址发出的那台路由器
* EBGP
  * 邻居处于不同的AS中
    * 通过EBGP学习到的路由管理距离为20
    * EBGP邻居为了安全考虑，传递数据包的TTL默认为1
    * EBGP邻居传递路由默认会修改下一跳地址为发出的那台路由器

#### BGP消息类型







***

#### 五种报文

| 报文名称      | 作用                                 | 发包时间                                                     |
| ------------- | ------------------------------------ | ------------------------------------------------------------ |
| OPEN          | 协商BGP邻居的各项参数，建⽴ 邻居关系 | 通过TCP建⽴BGP连接，发送 OPEN                                |
| UPDATE        | 进⾏路由信息的交换                   | 连接建⽴之后，有路由需要发送或 者是路由变化，发送update通告 对端的路由信息 |
| NOTIFICATION  | 报告错误，终⽌邻居关系               | 当BGP运⾏中发⽣错误的时候， 需要发送NOTIFICATION报⽂通 告BGP对端 |
| KEEPALIVE     | 维持邻居关系                         | 定时发送KEEPALIVE保持BGP邻 居关系的有效性                    |
| Route-refresh | 为保证⽹络稳定，触发更新路由 的机制  | 当路由策略发⽣变化，触发请求邻 居重新通告路由                |

#### BGP有限状态机

| 状态名称    | 发什么包        | 功能                                                         |
| ----------- | --------------- | ------------------------------------------------------------ |
| Idle        | 尝试建⽴TCP     | 开始准备tcp连接，监听远程peer启动tcp连接，启⽤ bgp时需要较⾼的资源 |
| Connect     | 发送tcp         | 正则进⾏tcp连接，如果连接时报会进⼊Active状态，反 复尝试连接 |
| Active      | 发送tcp包       | 继续进⾏tcp连接                                              |
| OpenSent    | 发送OPEN包      | tcp连接已经完成建⽴，开始发送OPEN包，协商各种参 数以及邻居的建⽴ |
| OpenConfirm | 发送KEEPALIVE包 | 协商成功之后，进⼊邻居保活                                   |
| Established | 发送UPDATE      | 收到对⽅的KEEPALIVE包，性能⼀致，开始更新双⽅的 路由信息     |

#### BGP维护

* 硬重置（不推荐)
  * 断开所有的TCP链接以及邻居关系
  * 会导致断网
  * clear ip bgp *
* 软重置
  * 不拆除并重建TCP，BGP链接，而仅仅触发更新的操作以便让新生的路由策略生效
  * 软重置可以针对出站，入站，也可以同时出站和入站
  * clear ip bgp * soft

***

##### 水平分割原则

* BGP没有通过AS_PATH实现防环，但是AS_PATH离开AS后才会被更改，在AS内部IBGP邻居没有防环能力，为了防⽌环路出现，BGP路由器不会将从IBGP邻居学习过来的路由通告给⾃⼰其他 IBGP邻居
* 由于水平分割原则，在AS内部，需要保证全联网

![image-20220719190132275](C:\Users\xz\AppData\Roaming\Typora\typora-user-images\image-20220719190132275.png)

#### BGP路由黑洞解决

#### 重发布BGP路由进入IGP





***

#### 路由反射器

* 指定⼀台路由器为路由反射器
* 其他所有路由器和路由反射器建⽴IBGP邻居
* 当其他路由器有路由更新时会将更细腻的路由发给路由反射器，路由反射器会将消息全部告诉给其他 IBGP邻居





***

#### BGP常见属性

* 公认属性
  * 公认强制属性
  * 公认自由决定属性
* 可选属性
  * 可选传递的
  * 可选非传递的
